<%@page import="board.model.ImageBoard"%>
<%@page import="board.model.ImageBoardDAO"%>
<%@page import="common.FileManager"%>
<%@page import="org.apache.commons.fileupload.FileItem"%>
<%@page import="java.util.List"%>
<%@page import="java.io.File"%>
<%@page import="org.apache.commons.fileupload.disk.DiskFileItemFactory"%>
<%@page import="org.apache.commons.fileupload.servlet.ServletFileUpload"%>
<%@ page contentType="text/html;charset=utf-8"%>
<%@ include file="/inc/lib.jsp" %>
<%! //멤버영역
	String saveDir="C:/workspace/javaEE_workspace/BoardApp/WebContent/data";	
	int maxSize=3*1024*1024; //3M byte
	ImageBoardDAO dao = new ImageBoardDAO();
%>
<%
	//실습햇던 예제보다 기능이 더 추가됨, db에 넣어야 함.. DAO이용
	
	
	//업로드컴포넌트에 대한 설정을 하기 위해 FileItemFactory객체를 이용해야 한다..
	DiskFileItemFactory itemFactory=new DiskFileItemFactory();
	itemFactory.setRepository(new File(saveDir));
	itemFactory.setSizeThreshold(maxSize);
	
	ServletFileUpload upload=new ServletFileUpload(itemFactory);
	
	//업로드된 정보 분석!!! 각각의 컴포넌트들을  FileItem 단위로 쪼갠다..
	//FileItem 은 클라이언트의 전송 정보 하나 하나를 의미한다. 즉 html에서의 input 텍스트박스, file 컴포넌트 들..
	//우리의 경우 input type="text" 가 FileItem에 담기고 
	//우리의 경우 input type="file" 가 FileItem에 담기고
	request.setCharacterEncoding("utf-8");
	List<FileItem> items=upload.parseRequest(request);
	ImageBoard vo = new ImageBoard();
	for(FileItem item : items){
		if(item.isFormField()){ //textfield 라면...db에 넣어야지
			//vo에 덱트스 필드들의 값을 담자!!
			if(item.getFieldName().equals("author")){
				vo.setAuthor(item.getString());
			}else if(item.getFieldName().equals("title")){
				vo.setTitle(item.getString());
			}else if (item.getFieldName().equals("content")){
				vo.setContent(item.getString());
			}
		}else{ // textfield가 아니라면..업로드 처리
			String newName=System.currentTimeMillis()+"."+FileManager.getExtend(item.getName());
			String destFile = saveDir+"/"+newName;
			File file = new File(destFile);
			item.write(file);//물리적 저장 시점!!!	
			
			out.print("업로드 완료");
			vo.setFilename(newName);
		}
	}
	if(dao.insert(vo) == 0){
		out.print(getMsgBack("실패"));
	}else{
		out.print(getMsgURL("성공", "/imageboard/list.jsp"));
	}
	
%>